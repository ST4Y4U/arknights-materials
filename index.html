<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>명일방주 재료 계산기</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0f1115; --panel:#171a21; --muted:#aab2c0; --pri:#20c997; --bd:#2a2f3a; --card:#1b1f27; --sel:#243548;}
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif; background:var(--bg); color:#e6e9ef; display:flex; flex-direction:column; min-height:100vh}
    header{padding:12px 16px; background:#10131a; border-bottom:1px solid var(--bd); display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header h1{margin:0; font-size:18px; font-weight:600}
    .sp{flex:1}
    .ctrl{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="search"]{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:8px 10px; border-radius:8px; width:240px}
    label.switch, select{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:6px 10px; border-radius:8px; font-size:12px}
    main{display:grid; grid-template-columns: 1fr 1fr; gap:0; flex:1; min-height:0}
    #left{border-right:1px solid var(--bd); min-height:0; display:flex; flex-direction:column}
    #gallery{padding:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; overflow:auto}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:8px; cursor:pointer; transition:transform .05s ease; display:flex; flex-direction:column; gap:6px}
    .card:hover{transform:translateY(-1px)}
    .card.selected{outline:2px solid var(--pri); background:var(--sel)}
    .card img{width:100%; aspect-ratio:4/3; object-fit:cover; border-radius:8px; background:#0b0d12}
    .name{font-size:13px; font-weight:600}
    .tags{display:flex; flex-wrap:wrap; gap:6px}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; background:#0f1420; border:1px solid var(--bd); color:var(--muted)}
    #tagBar{padding:8px 12px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px solid var(--bd)}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--bd); background:var(--panel); cursor:pointer; color:#cfd6e3}
    .chip.active{outline:2px solid var(--pri)}
    #right{min-height:0; display:flex; flex-direction:column}
    #details{padding:12px; overflow:auto}
    #details h2{margin:4px 0 8px; font-size:18px}
    #details h3{margin:14px 0 6px; font-size:14px; color:var(--muted)}
    #details ul{margin:0; padding-left:16px}
    #details li{margin:2px 0; font-size:13px}
    button{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:8px 10px; border-radius:8px; cursor:pointer}
    button.danger{border-color:#5b2d2d; background:#261416}
    #basketWrap{background:#0f131a; border-top:1px solid var(--bd)}
    details{padding:8px 12px}
    details>summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px}
    details>summary::-webkit-details-marker{display:none}
    .pill{font-size:12px; color:#9fb; background:#0f1d18; border:1px solid #1d3; padding:2px 8px; border-radius:999px}
    table{width:100%; border-collapse:collapse; font-size:13px; margin-top:8px}
    th,td{border:1px solid var(--bd); padding:6px; text-align:center}
    th{background:#121722; color:#cdd6e5; position:sticky; top:0}
    td img{width:22px; height:22px; object-fit:contain; border-radius:4px; background:#0b0d12}
    .toolRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .small{font-size:12px; color:var(--muted)}
    .selList{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
    .selItem{display:inline-flex; gap:6px; align-items:center; background:var(--panel); border:1px solid var(--bd); padding:6px 8px; border-radius:999px}
    .selItem button{padding:2px 6px; font-size:12px}
    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0}
    tr.group td{ background:#121722; color:#cdd6e5; text-align:left; font-weight:700}
    @media (max-width: 1024px){
      main{grid-template-columns:1fr}
      #left{border-right:none; border-bottom:1px solid var(--bd)}
    }
  </style>
</head>
<body>
  <header>
    <h1>명일방주 재료 계산기</h1>
    <div class="sp"></div>
    <div class="ctrl">
      <input id="q" type="search" placeholder="캐릭터 검색 (이름/태그)" />
      <label class="switch"><input type="checkbox" id="expandToggle" /> 하위 재료 포함</label>
      <select id="groupBy">
        <option value="rarity">정렬: 희귀도</option>
        <option value="tier">정렬: 티어(최상/상/중/하)</option>
      </select>
    </div>
  </header>

  <main>
    <section id="left">
      <div id="gallery"></div>
      <div id="tagBar"></div>
    </section>

    <section id="right">
      <div class="rightTools">
        <button id="clearSel">선택 초기화</button>
        <button id="clearOwn" class="danger">확보 수량 초기화</button>
        <span class="small" id="selMeta"></span>
      </div>
      <div id="details"><em class="small">좌측에서 캐릭터를 선택해.</em></div>
    </section>
  </main>

  <section id="basketWrap">
    <details open>
      <summary>
        <strong>장바구니 합계</strong>
        <span class="pill" id="selCount">0명 선택됨</span>
      </summary>

      <div class="toolRow">
        <div class="selList" id="selList"></div>
      </div>

      <table id="basketTable">
        <thead>
          <tr><th>아이콘</th><th>재료</th><th>필요</th><th>확보</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3 style="margin-top:16px">통화 / EXP</h3>
      <table id="basketMisc">
        <thead>
          <tr><th>아이콘</th><th>이름</th><th>필요</th><th>확보</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small">확보 수량은 이 브라우저의 LocalStorage에 저장된다.</p>
    </details>
  </section>

<script>
/* ---------- 상태 ---------- */
let data = [];
let materials = {};
let costs = {};              // 선택 파일(없어도 동작)
let selected = [];           // 선택된 캐릭터 인덱스 배열
let lastDetail = -1;         // 마지막 상세 인덱스
let owned = JSON.parse(localStorage.getItem("owned_v1") || "{}");
let expand = false;
let activeTags = new Set();
let query = "";
let groupBy = "rarity";

/* ---------- 티어 ---------- */
const TIER_ORDER = ["top","high","mid","low"];
const TIER_LABEL = { top:"최상위", high:"상위", mid:"중위", low:"하위" };
const tierRank = t => {
  const idx = TIER_ORDER.indexOf(String(t||"low").toLowerCase());
  return idx === -1 ? TIER_ORDER.length : idx;
};

/* ---------- 유틸 ---------- */
const $ = sel => document.querySelector(sel);
function disp(name){ return (materials[name]?.label?.ko) || name; }
function slug(name){ return String(name||"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""); }
function imgTag(src, name){
  const guess = `icons/${slug(name)}.png`;
  const s = (src && String(src).trim()) ? src : guess;
  const ph = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><rect width="100%25" height="100%25" fill="%2310171f"/></svg>';
  return `<img src="${s}" width="22" height="22" onerror="this.src='${ph}'">`;
}
function sumInto(target, delta){
  for(const [k,v] of Object.entries(delta)){
    target[k] = (target[k] || 0) + v;
  }
}
async function fetchJSON(url, fallback={}){
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }catch(e){
    return fallback; // costs.json 등 없으면 빈 객체로
  }
}

/* ---------- 초기화 ---------- */
(async function init(){
  [data, materials, costs] = await Promise.all([
    fetchJSON("data.json", []),
    fetchJSON("materials.json", {}),
    fetchJSON("costs.json", {})   // 없으면 빈 객체
  ]);
  renderTagBar();
  renderGallery();
  renderBasket();
  bindEvents();
})();

/* ---------- 이벤트 ---------- */
function bindEvents(){
  $("#expandToggle").addEventListener("change", e=>{
    expand = e.target.checked;
    renderBasket();
  });
  $("#groupBy").addEventListener("change", e=>{
    groupBy = e.target.value;
    renderBasket();
  });
  $("#q").addEventListener("input", e=>{
    query = e.target.value.trim().toLowerCase();
    renderGallery();
  });
  $("#clearSel").addEventListener("click", ()=>{
    selected = []; lastDetail = -1;
    renderGallery(); renderDetails(); renderBasket();
  });
  $("#clearOwn").addEventListener("click", ()=>{
    owned = {}; localStorage.setItem("owned_v1", JSON.stringify(owned));
    renderBasket();
  });
}

/* ---------- 태그 바 ---------- */
function renderTagBar(){
  const bar = document.getElementById("tagBar");
  bar.innerHTML = "";
  const tagSet = new Set();
  data.forEach(ch => (ch.tags||[]).forEach(t=>tagSet.add(t)));
  const tags = Array.from(tagSet).sort((a,b)=>a.localeCompare(b));
  if(tags.length===0){ bar.innerHTML = `<span class="small">태그 없음</span>`; return; }
  tags.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "chip";
    btn.textContent = t;
    btn.onclick = ()=>{
      if(activeTags.has(t)) activeTags.delete(t);
      else activeTags.add(t);
      btn.classList.toggle("active");
      renderGallery();
    };
    bar.appendChild(btn);
  });
}

/* ---------- 갤러리 ---------- */
function matchesFilters(ch){
  const q = query;
  const inName = (ch.name||"").toLowerCase().includes(q);
  const inTags = (ch.tags||[]).some(tag => tag.toLowerCase().includes(q));
  const queryPass = q==="" ? true : (inName || inTags);
  const tagsPass = activeTags.size===0 ? true : (ch.tags||[]).some(t=>activeTags.has(t));
  return queryPass && tagsPass;
}
function renderGallery(){
  const g = document.getElementById("gallery");
  g.innerHTML = "";
  const items = data.filter(matchesFilters);
  items.forEach(ch=>{
    const idx = data.indexOf(ch);
    const card = document.createElement("div");
    card.className = "card" + (selected.includes(idx) ? " selected" : "");
    card.innerHTML = `
      <img src="${ch.image||""}" alt="" onerror="this.style.display='none'">
      <div class="name">${ch.name||"(이름 없음)"}</div>
      <div class="tags">${(ch.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>
    `;
    card.onclick = ()=>{
      toggleSelect(idx);
      lastDetail = idx;
      renderDetails();
    };
    g.appendChild(card);
  });
  document.getElementById("selMeta").textContent = `${selected.length}명 선택됨`;
}
function toggleSelect(i){
  const pos = selected.indexOf(i);
  if(pos===-1) selected.push(i);
  else selected.splice(pos,1);
  renderGallery(); renderBasket();
}

/* ---------- 상세 ---------- */
function renderDetails(){
  const d = document.getElementById("details");
  if(selected.length===0){ d.innerHTML = `<em class="small">좌측에서 캐릭터를 선택해.</em>`; return; }
  if(lastDetail===-1 || !selected.includes(lastDetail)) lastDetail = selected[selected.length-1];
  const ch = data[lastDetail];
  let html = `<h2>${ch.name}</h2>`;
  if(ch.image) html += `<div style="margin:6px 0 10px">${imgTag(ch.image, ch.name)}</div>`;
  for(const [stage, mats] of Object.entries(ch.stages||{})){
    html += `<h3>${stage}</h3><ul>`;
    (mats||[]).forEach(m=>{
      const label = disp(m.name);
      html += `<li>${label} × ${m.count}</li>`;
    });
    html += `</ul>`;
  }
  html += `<div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
            <button onclick="toggleSelect(${lastDetail})">선택 해제</button>
          </div>`;
  d.innerHTML = html;
}

/* ---------- 재귀 확장 ---------- */
function expandMaterial(name, count){
  if(!expand) return {[name]: count};
  const meta = materials[name];
  const craft = meta?.craft || [];
  if(craft.length===0) return {[name]: count};
  let acc = {};
  craft.forEach(c=>{
    const sub = expandMaterial(c.name, c.count * count);
    sumInto(acc, sub);
  });
  return acc;
}

/* ---------- 성급·단계 LMD/EXP 자동 주입 ---------- */
function injectCosts(ch, stageKey, acc){
  const r = String(ch.rarity ?? "");
  const sc = costs?.promotion_costs?.[r]?.[stageKey];
  if(!sc) return;
  if(sc.LMD) acc["LMD"] = (acc["LMD"]||0) + sc.LMD;
  if(sc.EXP) acc["EXP"] = (acc["EXP"]||0) + sc.EXP;
}

/* ---------- 장바구니 ---------- */
function renderBasket(){
  document.getElementById("selCount").textContent = `${selected.length}명 선택됨`;

  // 선택 목록
  const listWrap = document.getElementById("selList");
  listWrap.innerHTML = "";
  selected.forEach(i=>{
    const ch = data[i];
    const node = document.createElement("div");
    node.className = "selItem";
    node.innerHTML = `<span>${ch.name}</span>
                      <button onclick="toggleSelect(${i})">제거</button>`;
    listWrap.appendChild(node);
  });

  // 합산
  let sum = {};
  selected.forEach(i=>{
    const ch = data[i];
    for(const [stageKey, mats] of Object.entries(ch.stages||{})){
      (mats||[]).forEach(m=>{
        const expanded = expandMaterial(m.name, m.count);
        sumInto(sum, expanded);
      });
      injectCosts(ch, stageKey, sum);
    }
  });

  const rows = Object.keys(sum).map(name=>{
    const meta = materials[name] || {};
    return {
      name,
      label: (meta.label?.ko) || name,
      count: sum[name],
      rarity: meta.rarity ?? 0,
      icon: meta.icon || "",
      type: meta.type || "material",
      tier: meta.tier || "low"
    };
  });

  const cmp = (a,b)=>{
    if(groupBy==="tier"){
      const t = tierRank(a.tier) - tierRank(b.tier);
      if(t!==0) return t;
      const r = (b.rarity - a.rarity);
      if(r!==0) return r;
      return a.label.localeCompare(b.label);
    }else{
      const r = (b.rarity - a.rarity);
      if(r!==0) return r;
      return a.label.localeCompare(b.label);
    }
  };

  const main = rows.filter(x=>x.type==="material").sort(cmp);
  const misc = rows.filter(x=>x.type==="currency" || x.type==="exp")
                   .sort((a,b)=>a.label.localeCompare(b.label));

  const bodyMain = document.querySelector("#basketTable tbody");
  const bodyMisc = document.querySelector("#basketMisc tbody");
  bodyMain.innerHTML = ""; bodyMisc.innerHTML = "";

  const renderRows = (arr, tbody)=>{
    // 티어 그룹 헤더
    let prevTier = null;
    arr.forEach(m=>{
      if(groupBy==="tier"){
        const t = String(m.tier||"low").toLowerCase();
        if(t!==prevTier){
          const gh = document.createElement("tr");
          gh.className = "group";
          gh.innerHTML = `<td colspan="4">${TIER_LABEL[t]||"하위"}</td>`;
          tbody.appendChild(gh);
          prevTier = t;
        }
      }
      const have = owned[m.name] || 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${imgTag(m.icon, m.name)}</td>
        <td>${m.label}</td>
        <td>${m.count}</td>
        <td>
          <input type="number" value="${have}" min="0"
            style="width:90px;background:var(--panel);border:1px solid var(--bd);color:#e6e9ef;padding:6px;border-radius:6px"
            onchange="updateOwned('${m.name}', this.value)" />
        </td>`;
      tbody.appendChild(tr);
    });
  };

  renderRows(main, bodyMain);
  renderRows(misc, bodyMisc);
}

function updateOwned(name, val){
  owned[name] = Math.max(0, parseInt(val||"0",10)||0);
  localStorage.setItem("owned_v1", JSON.stringify(owned));
}
</script>
</body>
</html>
