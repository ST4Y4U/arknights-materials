<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>명일방주 재료 계산기</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0f1115; --panel:#171a21; --muted:#aab2c0; --pri:#20c997; --bd:#2a2f3a; --card:#1b1f27; --sel:#243548;}
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif; background:var(--bg); color:#e6e9ef; display:flex; flex-direction:column; min-height:100vh}
    header{padding:12px 16px; background:#10131a; border-bottom:1px solid var(--bd); display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    header h1{margin:0; font-size:18px; font-weight:600}
    .sp{flex:1}
    .ctrl{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="search"]{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:8px 10px; border-radius:8px; width:240px}
    label.switch, select, button{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer}
    main{display:grid; grid-template-columns: 1fr 1fr; gap:0; flex:1; min-height:0}
    #left{border-right:1px solid var(--bd); min-height:0; display:flex; flex-direction:column}
    #gallery{padding:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; overflow:auto}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:8px; cursor:pointer; transition:transform .05s ease; display:flex; flex-direction:column; gap:6px}
    .card:hover{transform:translateY(-1px)}
    .card.selected{outline:2px solid var(--pri); background:var(--sel)}
    .card img{width:100%; aspect-ratio:4/3; object-fit:contain; padding:8px; border-radius:8px; background:#0b0d12}
    .name{font-size:13px; font-weight:600}
    .tags{display:flex; flex-wrap:wrap; gap:6px}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; background:#0f1420; border:1px solid var(--bd); color:#aab2c0}
    #tagBar{padding:8px 12px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px solid var(--bd)}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--bd); background:var(--panel); cursor:pointer; color:#cfd6e3}
    .chip.active{outline:2px solid var(--pri)}
    #right{min-height:0; display:flex; flex-direction:column}
    #details{padding:12px; overflow:auto; position:relative}
    #details h2{margin:4px 0 8px; font-size:18px}
    #details h3{margin:14px 0 6px; font-size:14px; color:#aab2c0}
    #details ul{margin:0; padding-left:16px}
    #details li{margin:2px 0; font-size:13px}
    .detailWrap{ position:relative; }
    .detailContent{ position:relative; z-index:1; }
    .bgE2{ position:absolute; inset:0; background:center/contain no-repeat; opacity:0; transition:opacity .35s ease; filter:grayscale(100%); pointer-events:none; }
    .bgE2.show{ opacity:.14; }
    .skOpts{display:grid;gap:8px;margin:8px 0}
    .skRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .skRow strong{min-width:48px;font-size:12px}
    .skRow label{font-size:12px}
    .skPrev table{width:100%;border-collapse:collapse;font-size:12px;margin-top:6px}
    .skPrev th,.skPrev td{border:1px solid var(--bd);padding:6px;text-align:center}
    .skPrev th{background:#121722;color:#cdd6e5}
    button.danger{border-color:#5b2d2d; background:#261416}
    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0}
    #basketWrap{background:#0f131a; border-top:1px solid var(--bd)}
    details{padding:8px 12px}
    details>summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px}
    details>summary::-webkit-details-marker{display:none}
    .pill{font-size:12px; color:#9fb; background:#0f1d18; border:1px solid #1d3; padding:2px 8px; border-radius:999px}
    table{width:100%; border-collapse:collapse; font-size:13px; margin-top:8px}
    th,td{border:1px solid var(--bd); padding:6px; text-align:center}
    th{background:#121722; color:#cdd6e5; position:sticky; top:0; z-index:1}
    td img{width:22px; height:22px; object-fit:contain; border-radius:4px; background:#0b0d12}
    .toolRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .small{font-size:12px; color:#aab2c0}
    .selList{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; max-height:120px; overflow:auto; padding:4px}
    .selItem{display:inline-flex; gap:6px; align-items:center; background:var(--panel); border:1px solid var(--bd); padding:4px 6px; border-radius:999px}
    .selItem button{padding:0; width:20px; height:20px; line-height:18px; font-size:14px; border-radius:10px}
    tr.group td{ background:#121722; color:#cdd6e5; text-align:left; font-weight:700}
    .scrollArea{ max-height:360px; overflow:auto; border:1px solid var(--bd); border-radius:8px; }
    .scrollArea table{ margin:0; }
    @media (max-width: 1024px){
      main{grid-template-columns:1fr}
      #left{border-right:none; border-bottom:1px solid var(--bd)}
    }
  </style>
</head>
<body>
  <header>
    <h1>명일방주 재료 계산기</h1>
    <div class="sp"></div>
    <div class="ctrl">
      <input id="q" type="search" placeholder="캐릭터 검색 (이름/태그)" />
      <label class="switch"><input type="checkbox" id="expandToggle" /> 하위 재료 포함</label>
      <select id="groupBy">
        <option value="rarity">정렬: 희귀도(합계표)</option>
        <option value="tier">정렬: 티어(합계표)</option>
      </select>
      <select id="sortBy">
        <option value="release">정렬: 출시순(갤러리)</option>
        <option value="rarity">정렬: 희귀도(갤러리)</option>
        <option value="name">정렬: 이름(갤러리)</option>
      </select>
      <button id="sortDirBtn">오름차순</button>
    </div>
  </header>

  <main>
    <section id="left">
      <div id="gallery"></div>
      <div id="tagBar"></div>
    </section>

    <section id="right">
      <div class="rightTools">
        <button id="clearSel">선택 초기화</button>
        <button id="clearOwn" class="danger">확보 수량 초기화</button>
        <span class="small" id="selMeta"></span>
      </div>
      <div id="details"><em class="small">좌측에서 캐릭터를 선택해.</em></div>
    </section>
  </main>

  <section id="basketWrap">
    <details open>
      <summary>
        <strong>장바구니 합계</strong>
        <span class="pill" id="selCount">0명 선택됨</span>
      </summary>

      <div class="toolRow">
        <div class="selList" id="selList"></div>
      </div>

      <div class="scrollArea">
        <table id="basketTable">
          <thead>
            <tr><th>아이콘</th><th>재료</th><th>필요</th><th>확보</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">통화 / EXP</h3>
      <div class="scrollArea">
        <table id="basketMisc">
          <thead>
            <tr><th>아이콘</th><th>이름</th><th>필요</th><th>확보</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="small">확보 수량은 이 브라우저의 LocalStorage에 저장된다.</p>
    </details>
  </section>

<script>
/* ---------- 라벨/상수 ---------- */
const STAGE_LABELS = { E1: "1차 정예화", E2: "2차 정예화" };
const stageDisp = s => STAGE_LABELS[s] || s;
const TIER_ORDER = ["top","high","mid","low"];
const TIER_LABEL = { top:"최상위", high:"상위", mid:"중위", low:"하위" };
const tierRank = t => { const i=TIER_ORDER.indexOf(String(t||"low").toLowerCase()); return i===-1?TIER_ORDER.length:i; };

/* ---------- 상태 ---------- */
let data = [];
let materials = {};
let costs = {};
let selected = [];
let lastDetail = -1;
let owned = JSON.parse(localStorage.getItem("owned_v1") || "{}");
let expand = false;
let activeTags = new Set();
let query = "";
let groupBy = "rarity";
let sortBy = "release";
let sortDir = "asc";

/* 스킬 체크 옵션 v2: { char: { lv7:bool, s1:{m1,m2,m3}, s2:{}, s3:{} } } */
let skillOpt = JSON.parse(localStorage.getItem("skillOpt_v2") || "{}");
(function migrateSkillOpt(){
  if(localStorage.getItem("skillOpt_v2")) return;
  const old = localStorage.getItem("skillOpt_v1");
  if(!old) return;
  try{
    const v1 = JSON.parse(old); const v2 = {};
    Object.entries(v1).forEach(([k,v])=>{
      v2[k] = {
        lv7: !!(v?.s1?.lv7 || v?.s2?.lv7 || v?.s3?.lv7),
        s1: { m1:!!v?.s1?.m1, m2:!!v?.s1?.m2, m3:!!v?.s1?.m3 },
        s2: { m1:!!v?.s2?.m1, m2:!!v?.s2?.m2, m3:!!v?.s2?.m3 },
        s3: { m1:!!v?.s3?.m1, m2:!!v?.s3?.m2, m3:!!v?.s3?.m3 }
      };
    });
    localStorage.setItem("skillOpt_v2", JSON.stringify(v2));
    localStorage.removeItem("skillOpt_v1");
    skillOpt = v2;
  }catch{}
})();
function getSkillOpt(ch){
  const k = ch.name;
  if(!skillOpt[k]) skillOpt[k] = { lv7:false, s1:{m1:false,m2:false,m3:false}, s2:{m1:false,m2:false,m3:false}, s3:{m1:false,m2:false,m3:false} };
  return skillOpt[k];
}
function saveSkillOpt(){ localStorage.setItem("skillOpt_v2", JSON.stringify(skillOpt)); }

/* ---------- 캐시 ---------- */
const expandCache = new Map(); // 재료 1개당 분해표 캐시

/* ---------- 유틸 ---------- */
const $ = sel => document.querySelector(sel);
function disp(name){ return (materials[name]?.label?.ko) || name; }
function dispChar(ch){ return (ch.label?.ko) || ch.name; }
function slug(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""); }
function imgTag(src, name){
  const guess = name ? `icons/${slug(name)}.png` : (src||"");
  const s = (src && String(src).trim()) ? src : guess;
  const ph = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><rect width="100%25" height="100%25" fill="%2310171f"/></svg>';
  return `<img src="${s}" width="22" height="22" loading="lazy" decoding="async" onerror="this.src='${ph}'">`;
}
function sumInto(target, delta){ for(const [k,v] of Object.entries(delta)) target[k]=(target[k]||0)+v; }
async function fetchJSON(url, fb={}){ try{ const r=await fetch(url); if(!r.ok) throw 0; return await r.json(); }catch{ console.warn('LOAD_FAIL',url); return fb; } }

/* ---------- 초기화 ---------- */
(async function init(){
  [data, materials, costs] = await Promise.all([
    fetchJSON("data.json", []),
    fetchJSON("materials.json", {}),
    fetchJSON("costs.json", {})
  ]);
  renderTagBar();
  renderGallery();
  renderBasket();
  bindEvents();
})();

/* ---------- 이벤트 ---------- */
function bindEvents(){
  $("#expandToggle").addEventListener("change", e=>{ expand = e.target.checked; renderBasket(); });
  $("#groupBy").addEventListener("change", e=>{ groupBy = e.target.value; renderBasket(); });
  $("#sortBy").addEventListener("change", e=>{ sortBy = e.target.value; renderGallery(); });
  $("#sortDirBtn").addEventListener("click", ()=>{
    sortDir = (sortDir === "asc") ? "desc" : "asc";
    $("#sortDirBtn").textContent = (sortDir === "asc") ? "오름차순" : "내림차순";
    renderGallery();
  });
  let qTimer=null;
  $("#q").addEventListener("input", e=>{
    clearTimeout(qTimer);
    qTimer=setTimeout(()=>{ query = e.target.value.trim().toLowerCase(); renderGallery(); },150);
  });
  $("#clearSel").addEventListener("click", ()=>{ selected = []; lastDetail = -1; renderGallery(); renderDetails(); renderBasket(); });
  $("#clearOwn").addEventListener("click", ()=>{ owned = {}; localStorage.setItem("owned_v1", JSON.stringify(owned)); renderBasket(); });
}

/* ---------- 태그 바 ---------- */
function renderTagBar(){
  const bar = $("#tagBar"); bar.innerHTML = "";
  const tagSet = new Set(); data.forEach(ch => (ch.tags||[]).forEach(t=>tagSet.add(t)));
  const tags = Array.from(tagSet).sort((a,b)=>a.localeCompare(b,"ko"));
  if(tags.length===0){ bar.innerHTML = `<span class="small">태그 없음</span>`; return; }
  tags.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "chip"; btn.textContent = t;
    btn.onclick = ()=>{ if(activeTags.has(t)) activeTags.delete(t); else activeTags.add(t); btn.classList.toggle("active"); renderGallery(); };
    bar.appendChild(btn);
  });
}

/* ---------- 갤러리 ---------- */
function matchesFilters(ch){
  const q = query;
  const nameKo = (ch.label?.ko || "").toLowerCase();
  const nameEn = (ch.label?.en || ch.name || "").toLowerCase();
  const inName = nameKo.includes(q) || nameEn.includes(q);
  const inTags = (ch.tags||[]).some(tag => tag.toLowerCase().includes(q));
  const queryPass = q==="" ? true : (inName || inTags);
  const tagsPass = activeTags.size===0 ? true : (ch.tags||[]).some(t=>activeTags.has(t));
  return queryPass && tagsPass;
}
function renderGallery(){
  const g = $("#gallery"); g.innerHTML = "";
  const items = data.filter(matchesFilters);

  const nameKey = ch => (ch.label?.ko || ch.label?.en || ch.name || "");
  const getRelease = ch => (typeof ch.release === "number" ? ch.release :
                           (ch.releaseDate ? Date.parse(ch.releaseDate)||0 : 0));
  const cmpChar = (a,b)=>{
    let cmp = 0;
    if (sortBy === "release") cmp = getRelease(a) - getRelease(b);
    else if (sortBy === "rarity") cmp = (a.rarity||0) - (b.rarity||0);
    else cmp = nameKey(a).localeCompare(nameKey(b), "ko");
    if (cmp !== 0) return (sortDir === "asc") ? cmp : -cmp;
    return nameKey(a).localeCompare(nameKey(b), "ko");
  };
  items.sort(cmpChar);

  // 청크 렌더
  let i=0, chunk=36;
  (function pump(){
    const frag = document.createDocumentFragment();
    for(let k=0;k<chunk && i<items.length;k++,i++){
      const ch = items[i];
      const idx = data.indexOf(ch);
      const card = document.createElement("div");
      card.className = "card" + (selected.includes(idx) ? " selected" : "");
      card.innerHTML = `
        <img src="${ch.image||""}" loading="lazy" decoding="async" onerror="this.style.display='none'">
        <div class="name">${dispChar(ch)}</div>
        <div class="tags">${(ch.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>`;
      card.onclick = ()=>{ toggleSelect(idx); lastDetail=idx; renderDetails(); };
      frag.appendChild(card);
    }
    g.appendChild(frag);
    if(i<items.length) (window.requestIdleCallback||setTimeout)(pump, 0);
  })();
  $("#selMeta").textContent = `${selected.length}명 선택됨`;
}
function toggleSelect(i){
  const pos = selected.indexOf(i);
  if(pos===-1) selected.push(i); else selected.splice(pos,1);
  renderGallery(); renderBasket(); renderDetails();
}

/* ---------- 상세 ---------- */
function renderDetails(){
  const d = $("#details");
  if(selected.length===0){ d.innerHTML = `<em class="small">좌측에서 캐릭터를 선택해.</em>`; return; }
  if(lastDetail===-1 || !selected.includes(lastDetail)) lastDetail = selected[selected.length-1];
  const ch = data[lastDetail];

  // 본문
  let inner = `<h2>${dispChar(ch)}</h2>`;
  if(ch.image) inner += `<div style="margin:6px 0 10px">${imgTag(ch.image, ch.name)}</div>`;
  for(const [stage, mats] of Object.entries(ch.stages||{})){
    inner += `<h3>${stageDisp(stage)}</h3><ul>`;
    (mats||[]).forEach(m=>{ inner += `<li>${disp(m.name)} × ${m.count}</li>`; });
    inner += `</ul>`;
  }

  // 스킬 옵션: 1~7 공통, 마스터리 스킬별
  const opt = getSkillOpt(ch);
  const row = (key,label)=>{
    const o = opt[key];
    return `<div class="skRow">
      <strong>${label}</strong>
      <label><input type="checkbox" ${o.m1?'checked':''}   id="${key}_m1"> 8</label>
      <label><input type="checkbox" ${o.m2?'checked':''}   id="${key}_m2"> 9</label>
      <label><input type="checkbox" ${o.m3?'checked':''}   id="${key}_m3"> 10</label>
    </div>`;
  };
  inner += `<h3>스킬 옵션</h3>
  <div class="skOpts">
    <div class="skRow"><strong>공통</strong>
      <label><input type="checkbox" ${opt.lv7?'checked':''} id="lv7_all"> 1~7</label>
    </div>
    ${row("s1","스킬 1")}
    ${row("s2","스킬 2")}
    ${row("s3","스킬 3")}
  </div>
  <div class="skPrev" id="skillPreview"></div>`;

  // 래핑 + E2 배경
  d.innerHTML = `<div class="detailWrap">
                   <div class="bgE2" id="bgE2"></div>
                   <div class="detailContent">${inner}</div>
                 </div>`;
  const bg = d.querySelector("#bgE2");
  if(ch.imageE2){ bg.style.backgroundImage = `url('${ch.imageE2}')`; requestAnimationFrame(()=> bg.classList.add("show")); }

  // 스킬 체크 이벤트 + 미리보기 최초 렌더
  const lv7box = d.querySelector("#lv7_all");
  if(lv7box) lv7box.onchange = ()=>{ opt.lv7 = lv7box.checked; saveSkillOpt(); renderSkillPreview(ch); renderBasket(); };

  ["s1","s2","s3"].forEach(k=>{
    ["m1","m2","m3"].forEach(t=>{
      const el = d.querySelector(`#${k}_${t}`);
      if(el) el.onchange = ()=>{ opt[k][t] = el.checked; saveSkillOpt(); renderSkillPreview(ch); renderBasket(); };
    });
  });
  renderSkillPreview(ch);
}

/* ---------- 스킬 비용 계산/미리보기 ---------- */
function skillCostFor(ch){
  const opt = getSkillOpt(ch);
  const base = costs?.skill_levels || {};
  const ov   = costs?.skill_levels_override?.[ch.name] || {};
  const mst  = costs?.skill_mastery?.[ch.name] || {};
  let acc = {};
  const addObj = o=>{ if(!o) return; for(const [n,c] of Object.entries(o)) acc[n]=(acc[n]||0)+c; };
  const addLv1to7 = ()=>{ for(let lv=2; lv<=7; lv++){ const L=String(lv); addObj(base[L]); addObj(ov[L]); } };
  const addM = (sKey, mKey)=> addObj(mst?.[sKey]?.[mKey]);

  if(opt.lv7) addLv1to7();
  ["s1","s2","s3"].forEach(s=>{
    const o = opt[s]; if(!o) return;
    if(o.m1) addM(s,"M1");
    if(o.m2) addM(s,"M2");
    if(o.m3) addM(s,"M3");
  });
  return acc;
}
function renderSkillPreview(ch){
  const box = document.getElementById("skillPreview");
  if(!box) return;
  const sum = skillCostFor(ch);
  const rows = Object.keys(sum).map(name=>{
    const meta = materials[name]||{};
    return { name, label:(meta.label?.ko)||name, icon:meta.icon||"", type:meta.type||"material", count:sum[name] };
  });
  const isMisc = r => r.type==="currency" || r.type==="exp" || r.name==="LMD" || r.name==="EXP";
  const main = rows.filter(r=>!isMisc(r)).sort((a,b)=>a.label.localeCompare(b.label,"ko"));
  const misc = rows.filter(isMisc).sort((a,b)=>a.label.localeCompare(b.label,"ko"));

  const mk = (title, arr)=> arr.length? `
    <h4 style="margin:10px 0 4px;color:#aab2c0;font-size:12px">${title}</h4>
    <table><thead><tr><th>아이콘</th><th>재료</th><th>수량</th></tr></thead>
    <tbody>
      ${arr.map(m=>`<tr>
        <td>${imgTag(m.icon, m.name)}</td>
        <td>${m.label}</td>
        <td>${m.count}</td>
      </tr>`).join("")}
    </tbody></table>` : "";
  box.innerHTML = mk("스킬 재료 합계", main) + mk("통화 / EXP 합계", misc);
}

/* ---------- 재귀 확장(캐시) ---------- */
function expandMaterial(name, count){
  if(!expand) return {[name]: count};
  const meta = materials[name], craft = meta?.craft || [];
  if(craft.length===0) return {[name]: count};
  if(!expandCache.has(name)){
    let unit={}; craft.forEach(c=> sumInto(unit, expandMaterial(c.name, c.count)));
    expandCache.set(name, unit);
  }
  const base = expandCache.get(name);
  let acc={}; Object.entries(base).forEach(([k,v])=> acc[k]=(acc[k]||0)+v*count);
  return acc;
}

/* ---------- 정예화 비용 주입(promotion_costs + promotion_fee) ---------- */
function injectCosts(ch, stageKey, acc){
  const add = (obj)=>{ if(!obj) return; for(const [k,v] of Object.entries(obj)) acc[k]=(acc[k]||0)+v; };
  const r = String(ch.rarity ?? "");
  const k = stageKey;
  const kKo = (typeof STAGE_LABELS!=="undefined" && STAGE_LABELS[k]) ? STAGE_LABELS[k] : k; // E1→"1차 정예화" 대응
  add((costs?.promotion_costs?.[r]?.[k])  || (costs?.promotion_costs?.[r]?.[kKo]));
  add((costs?.promotion_fee?.[r]?.[k])    || (costs?.promotion_fee?.[r]?.[kKo]));
}

/* ---------- 장바구니 ---------- */
function renderBasket(){
  $("#selCount").textContent = `${selected.length}명 선택됨`;

  // 선택 목록
  const listWrap = $("#selList"); listWrap.innerHTML = "";
  selected.forEach(i=>{
    const ch = data[i];
    const node = document.createElement("div");
    node.className = "selItem";
    node.innerHTML = `<button title="제거" onclick="toggleSelect(${i})">×</button><span>${dispChar(ch)}</span>`;
    listWrap.appendChild(node);
  });

  // 합산
  let sum = {};
  selected.forEach(i=>{
    const ch = data[i];
    for(const [stageKey, mats] of Object.entries(ch.stages||{})){
      (mats||[]).forEach(m=>{ sumInto(sum, expandMaterial(m.name, m.count)); });
      injectCosts(ch, stageKey, sum);
    }
    // 스킬 옵션 합산
    sumInto(sum, skillCostFor(ch));
  });

  const rows = Object.keys(sum).map(name=>{
    const meta = materials[name] || {};
    return {
      name,
      label: (meta.label?.ko) || name,
      count: sum[name],
      rarity: meta.rarity ?? 0,
      icon: meta.icon || "",
      type: meta.type || "material",
      tier: meta.tier || "low"
    };
  });

  const isMisc = r => r.type==="currency" || r.type==="exp" || r.name==="LMD" || r.name==="EXP";
  const cmp = (a,b)=>{
    if(groupBy==="tier"){
      const t = tierRank(a.tier) - tierRank(b.tier); if(t!==0) return t;
      const r = b.rarity - a.rarity; if(r!==0) return r;
      return a.label.localeCompare(b.label,"ko");
    }else{
      const r = b.rarity - a.rarity; if(r!==0) return r;
      return a.label.localeCompare(b.label,"ko");
    }
  };

  const main = rows.filter(x=>!isMisc(x)).sort(cmp);
  const misc = rows.filter(isMisc).sort((a,b)=>a.label.localeCompare(b.label,"ko"));

  const bodyMain = document.querySelector("#basketTable tbody");
  const bodyMisc = document.querySelector("#basketMisc tbody");
  bodyMain.innerHTML = ""; bodyMisc.innerHTML = "";

  const renderRows = (arr, tbody)=>{
    let prevTier = null;
    arr.forEach(m=>{
      if(groupBy==="tier" && !isMisc(m)){
        const t = String(m.tier||"low").toLowerCase();
        if(t!==prevTier){
          const gh = document.createElement("tr");
          gh.className = "group";
          gh.innerHTML = `<td colspan="4">${TIER_LABEL[t]||"하위"}</td>`;
          tbody.appendChild(gh); prevTier = t;
        }
      }
      const have = owned[m.name] || 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${imgTag(m.icon, m.name)}</td>
        <td>${m.label}</td>
        <td>${m.count}</td>
        <td><input type="number" value="${have}" min="0"
          style="width:90px;background:var(--panel);border:1px solid var(--bd);color:#e6e9ef;padding:6px;border-radius:6px"
          onchange="updateOwned('${m.name}', this.value)" /></td>`;
      tbody.appendChild(tr);
    });
  };

  renderRows(main, bodyMain);
  renderRows(misc, bodyMisc);
}

function updateOwned(name, val){
  owned[name] = Math.max(0, parseInt(val||"0",10)||0);
  localStorage.setItem("owned_v1", JSON.stringify(owned));
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>명일방주 재료 계산기</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0f1115; --panel:#171a21; --muted:#aab2c0; --pri:#20c997; --bd:#2a2f3a; --card:#1b1f27; --sel:#243548;}
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif; background:var(--bg); color:#e6e9ef; display:flex; flex-direction:column; min-height:100vh}
    header{padding:12px 16px; background:#10131a; border-bottom:1px solid var(--bd); display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    header h1{margin:0; font-size:18px; font-weight:600}
    .sp{flex:1}
    .ctrl{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="search"]{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:8px 10px; border-radius:8px; width:240px}
    label.switch, select, button{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer}
    main{display:grid; grid-template-columns: 1fr 1fr; gap:0; flex:1; min-height:0}
    #left{border-right:1px solid var(--bd); min-height:0; display:flex; flex-direction:column}
    #gallery{padding:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; overflow:auto}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:8px; cursor:pointer; transition:transform .05s ease; display:flex; flex-direction:column; gap:6px}
    .card:hover{transform:translateY(-1px)}
    .card.selected{outline:2px solid var(--pri); background:var(--sel)}
    .card img{width:100%; aspect-ratio:4/3; object-fit:contain; padding:8px; border-radius:8px; background:#0b0d12}
    .name{font-size:13px; font-weight:600}
    .tags{display:flex; flex-wrap:wrap; gap:6px}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; background:#0f1420; border:1px solid var(--bd); color:#aab2c0}
    #tagBar{padding:8px 12px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px solid var(--bd)}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--bd); background:var(--panel); cursor:pointer; color:#cfd6e3}
    .chip.active{outline:2px solid var(--pri)}
    #right{min-height:0; display:flex; flex-direction:column}
    #details{padding:12px; overflow:auto; position:relative}
    #details h2{margin:4px 0 8px; font-size:18px}
    #details h3{margin:14px 0 6px; font-size:14px; color:#aab2c0}
    #details ul{margin:0; padding-left:16px}
    #details li{margin:2px 0; font-size:13px}
    .detailWrap{ position:relative; }
    .detailContent{ position:relative; z-index:1; }
    .bgE2{ position:absolute; inset:0; background:center/contain no-repeat; opacity:0; transition:opacity .35s ease; filter:grayscale(100%); pointer-events:none; }
    .bgE2.show{ opacity:.14; }
    .skOpts{display:grid;gap:8px;margin:8px 0}
    .skRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .skRow strong{min-width:48px;font-size:12px}
    .skRow label{font-size:12px}
    .skPrev table{width:100%;border-collapse:collapse;font-size:12px;margin-top:6px}
    .skPrev th,.skPrev td{border:1px solid var(--bd);padding:6px;text-align:center}
    .skPrev th{background:#121722;color:#cdd6e5}
    button.danger{border-color:#5b2d2d; background:#261416}
    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0}
    #basketWrap{background:#0f131a; border-top:1px solid var(--bd)}
    details{padding:8px 12px}
    details>summary{cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px}
    details>summary::-webkit-details-marker{display:none}
    .pill{font-size:12px; color:#9fb; background:#0f1d18; border:1px solid #1d3; padding:2px 8px; border-radius:999px}
    table{width:100%; border-collapse:collapse; font-size:13px; margin-top:8px}
    th,td{border:1px solid var(--bd); padding:6px; text-align:center}
    th{background:#121722; color:#cdd6e5; position:sticky; top:0; z-index:1}
    td img{width:22px; height:22px; object-fit:contain; border-radius:4px; background:#0b0d12}
    .toolRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .small{font-size:12px; color:#aab2c0}
    .selList{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; max-height:120px; overflow:auto; padding:4px}
    .selItem{display:inline-flex; gap:6px; align-items:center; background:var(--panel); border:1px solid var(--bd); padding:6px 8px; border-radius:999px}
    .selItem button{padding:2px 6px; font-size:12px}
    tr.group td{ background:#121722; color:#cdd6e5; text-align:left; font-weight:700}
    .scrollArea{ max-height:360px; overflow:auto; border:1px solid var(--bd); border-radius:8px; }
    .scrollArea table{ margin:0; }
    @media (max-width: 1024px){
      main{grid-template-columns:1fr}
      #left{border-right:none; border-bottom:1px solid var(--bd)}
    }
  </style>
</head>
<body>
  <header>
    <h1>명일방주 재료 계산기</h1>
    <div class="sp"></div>
    <div class="ctrl">
      <input id="q" type="search" placeholder="캐릭터 검색 (이름/태그)" />
      <label class="switch"><input type="checkbox" id="expandToggle" /> 하위 재료 포함</label>
      <select id="groupBy">
        <option value="rarity">정렬: 희귀도</option>
        <option value="tier">정렬: 티어</option>
      </select>
      <select id="sortBy">
        <option value="release">정렬: 출시순</option>
        <option value="rarity">정렬: 희귀도</option>
        <option value="name">정렬: 이름</option>
      </select>
      <button id="sortDirBtn">오름차순</button>
    </div>
  </header>

  <main>
    <section id="left">
      <div id="gallery"></div>
      <div id="tagBar"></div>
    </section>

    <section id="right">
      <div class="rightTools">
        <button id="clearSel">선택 초기화</button>
        <button id="clearOwn" class="danger">확보 수량 초기화</button>
        <span class="small" id="selMeta"></span>
      </div>
      <div id="details"><em class="small">좌측에서 캐릭터를 선택하세요.</em></div>
    </section>
  </main>

  <section id="basketWrap">
    <details open>
      <summary>
        <strong>필요 재화 합계</strong>
        <span class="pill" id="selCount">0명 선택됨</span>
      </summary>

      <div class="toolRow">
        <div class="selList" id="selList"></div>
      </div>

      <div class="scrollArea">
        <table id="basketTable">
          <thead>
            <tr><th>아이콘</th><th>재료</th><th>필요</th><th>확보</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">LMD / EXP</h3>
      <div class="scrollArea">
        <table id="basketMisc">
          <thead>
            <tr><th>아이콘</th><th>이름</th><th>필요</th><th>확보</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="small">확보 수량은 이 브라우저의 LocalStorage에 저장됩니다.</p>
    </details>
  </section>

<script>
/* ---------- 라벨/상수 ---------- */
const STAGE_LABELS = { E1: "1차 정예화", E2: "2차 정예화" };
const stageDisp = s => STAGE_LABELS[s] || s;
const TIER_ORDER = ["top","high","mid","low"];
const TIER_LABEL = { top:"최상위", high:"상위", mid:"중위", low:"하위" };
const tierRank = t => { const i=TIER_ORDER.indexOf(String(t||"low").toLowerCase()); return i===-1?TIER_ORDER.length:i; };

/* ---------- 상태 ---------- */
let data = [];
let materials = {};
let costs = {};
let selected = [];
let lastDetail = -1;
let owned = JSON.parse(localStorage.getItem("owned_v1") || "{}");
let expand = false;
let activeTags = new Set();
let query = "";
let groupBy = "rarity";
let sortBy = "release";
let sortDir = "asc";

/* 스킬 체크 옵션(로컬 저장) */
let skillOpt = JSON.parse(localStorage.getItem("skillOpt_v1") || "{}");
// { "CharName": { s1:{lv7:false,m1:false,m2:false,m3:false}, s2:{...}, s3:{...} } }
function getSkillOpt(ch){
  const k = ch.name;
  if(!skillOpt[k]) skillOpt[k] = { s1:{lv7:false,m1:false,m2:false,m3:false},
                                   s2:{lv7:false,m1:false,m2:false,m3:false},
                                   s3:{lv7:false,m1:false,m2:false,m3:false} };
  return skillOpt[k];
}
function saveSkillOpt(){ localStorage.setItem("skillOpt_v1", JSON.stringify(skillOpt)); }

/* ---------- 캐시 ---------- */
const expandCache = new Map(); // 재료 1개당 분해표 캐시

/* ---------- 유틸 ---------- */
const $ = sel => document.querySelector(sel);
function disp(name){ return (materials[name]?.label?.ko) || name; }
function dispChar(ch){ return (ch.label?.ko) || ch.name; }
function slug(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""); }
function imgTag(src, name){
  const guess = name ? `icons/${slug(name)}.png` : (src||"");
  const s = (src && String(src).trim()) ? src : guess;
  const ph = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><rect width="100%25" height="100%25" fill="%2310171f"/></svg>';
  return `<img src="${s}" width="22" height="22" loading="lazy" decoding="async" onerror="this.src='${ph}'">`;
}
function sumInto(target, delta){ for(const [k,v] of Object.entries(delta)) target[k]=(target[k]||0)+v; }
async function fetchJSON(url, fb={}){ try{ const r=await fetch(url); if(!r.ok) throw 0; return await r.json(); }catch{ console.warn('LOAD_FAIL',url); return fb; } }

/* ---------- 초기화 ---------- */
(async function init(){
  [data, materials, costs] = await Promise.all([
    fetchJSON("data.json", []),
    fetchJSON("materials.json", {}),
    fetchJSON("costs.json", {})
  ]);
  renderTagBar();
  renderGallery();
  renderBasket();
  bindEvents();
})();

/* ---------- 이벤트 ---------- */
function bindEvents(){
  $("#expandToggle").addEventListener("change", e=>{ expand = e.target.checked; renderBasket(); });
  $("#groupBy").addEventListener("change", e=>{ groupBy = e.target.value; renderBasket(); });
  $("#sortBy").addEventListener("change", e=>{ sortBy = e.target.value; renderGallery(); });
  $("#sortDirBtn").addEventListener("click", ()=>{
    sortDir = (sortDir === "asc") ? "desc" : "asc";
    $("#sortDirBtn").textContent = (sortDir === "asc") ? "오름차순" : "내림차순";
    renderGallery();
  });
  let qTimer=null;
  $("#q").addEventListener("input", e=>{
    clearTimeout(qTimer);
    qTimer=setTimeout(()=>{ query = e.target.value.trim().toLowerCase(); renderGallery(); },150);
  });
  $("#clearSel").addEventListener("click", ()=>{ selected = []; lastDetail = -1; renderGallery(); renderDetails(); renderBasket(); });
  $("#clearOwn").addEventListener("click", ()=>{ owned = {}; localStorage.setItem("owned_v1", JSON.stringify(owned)); renderBasket(); });
}

/* ---------- 태그 바 ---------- */
function renderTagBar(){
  const bar = $("#tagBar"); bar.innerHTML = "";
  const tagSet = new Set(); data.forEach(ch => (ch.tags||[]).forEach(t=>tagSet.add(t)));
  const tags = Array.from(tagSet).sort((a,b)=>a.localeCompare(b,"ko"));
  if(tags.length===0){ bar.innerHTML = `<span class="small">태그 없음</span>`; return; }
  tags.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "chip"; btn.textContent = t;
    btn.onclick = ()=>{ if(activeTags.has(t)) activeTags.delete(t); else activeTags.add(t); btn.classList.toggle("active"); renderGallery(); };
    bar.appendChild(btn);
  });
}

/* ---------- 갤러리 ---------- */
function matchesFilters(ch){
  const q = query;
  const nameKo = (ch.label?.ko || "").toLowerCase();
  const nameEn = (ch.label?.en || ch.name || "").toLowerCase();
  const inName = nameKo.includes(q) || nameEn.includes(q);
  const inTags = (ch.tags||[]).some(tag => tag.toLowerCase().includes(q));
  const queryPass = q==="" ? true : (inName || inTags);
  const tagsPass = activeTags.size===0 ? true : (ch.tags||[]).some(t=>activeTags.has(t));
  return queryPass && tagsPass;
}
function renderGallery(){
  const g = $("#gallery"); g.innerHTML = "";
  const items = data.filter(matchesFilters);

  const nameKey = ch => (ch.label?.ko || ch.label?.en || ch.name || "");
  const getRelease = ch => (typeof ch.release === "number" ? ch.release :
                           (ch.releaseDate ? Date.parse(ch.releaseDate)||0 : 0));
  const cmpChar = (a,b)=>{
    let cmp = 0;
    if (sortBy === "release") cmp = getRelease(a) - getRelease(b);
    else if (sortBy === "rarity") cmp = (a.rarity||0) - (b.rarity||0);
    else cmp = nameKey(a).localeCompare(nameKey(b), "ko");
    if (cmp !== 0) return (sortDir === "asc") ? cmp : -cmp;
    return nameKey(a).localeCompare(nameKey(b), "ko");
  };
  items.sort(cmpChar);

  // 청크 렌더
  let i=0, chunk=36;
  (function pump(){
    const frag = document.createDocumentFragment();
    for(let k=0;k<chunk && i<items.length;k++,i++){
      const ch = items[i];
      const idx = data.indexOf(ch);
      const card = document.createElement("div");
      card.className = "card" + (selected.includes(idx) ? " selected" : "");
      card.innerHTML = `
        <img src="${ch.image||""}" loading="lazy" decoding="async" onerror="this.style.display='none'">
        <div class="name">${dispChar(ch)}</div>
        <div class="tags">${(ch.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>`;
      card.onclick = ()=>{ toggleSelect(idx); lastDetail=idx; renderDetails(); };
      frag.appendChild(card);
    }
    g.appendChild(frag);
    if(i<items.length) (window.requestIdleCallback||setTimeout)(pump, 0);
  })();
  $("#selMeta").textContent = `${selected.length}명 선택됨`;
}
function toggleSelect(i){
  const pos = selected.indexOf(i);
  if(pos===-1) selected.push(i); else selected.splice(pos,1);
  renderGallery(); renderBasket();
}

/* ---------- 상세 ---------- */
function renderDetails(){
  const d = $("#details");
  if(selected.length===0){ d.innerHTML = `<em class="small">좌측에서 캐릭터를 선택해.</em>`; return; }
  if(lastDetail===-1 || !selected.includes(lastDetail)) lastDetail = selected[selected.length-1];
  const ch = data[lastDetail];

  // 본문
  let inner = `<h2>${dispChar(ch)}</h2>`;
  if(ch.image) inner += `<div style="margin:6px 0 10px">${imgTag(ch.image, ch.name)}</div>`;
  for(const [stage, mats] of Object.entries(ch.stages||{})){
    inner += `<h3>${stageDisp(stage)}</h3><ul>`;
    (mats||[]).forEach(m=>{ inner += `<li>${disp(m.name)} × ${m.count}</li>`; });
    inner += `</ul>`;
  }

  // 스킬 옵션
  const opt = getSkillOpt(ch);
  const row = (key,label)=>{
    const o = opt[key];
    return `<div class="skRow">
      <strong>${label}</strong>
      <label><input type="checkbox" ${o.lv7?'checked':''}  id="${key}_lv7"> 1~7</label>
      <label><input type="checkbox" ${o.m1?'checked':''}   id="${key}_m1"> 8</label>
      <label><input type="checkbox" ${o.m2?'checked':''}   id="${key}_m2"> 9</label>
      <label><input type="checkbox" ${o.m3?'checked':''}   id="${key}_m3"> 10</label>
    </div>`;
  };
  inner += `<h3>스킬 옵션</h3>
  <div class="skOpts">
    ${row("s1","스킬 1")}
    ${row("s2","스킬 2")}
    ${row("s3","스킬 3")}
  </div>
  <div class="skPrev" id="skillPreview"></div>`;

  inner += `<div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
              <button onclick="toggleSelect(${lastDetail})">선택 해제</button>
            </div>`;

  // 래핑 + E2 배경
  d.innerHTML = `<div class="detailWrap">
                   <div class="bgE2" id="bgE2"></div>
                   <div class="detailContent">${inner}</div>
                 </div>`;
  const bg = d.querySelector("#bgE2");
  if(ch.imageE2){ bg.style.backgroundImage = `url('${ch.imageE2}')`; requestAnimationFrame(()=> bg.classList.add("show")); }

  // 스킬 체크 이벤트 + 미리보기 최초 렌더
  ["s1","s2","s3"].forEach(k=>{
    ["lv7","m1","m2","m3"].forEach(t=>{
      const el = d.querySelector(`#${k}_${t}`);
      if(el) el.onchange = ()=>{ opt[k][t] = el.checked; saveSkillOpt(); renderSkillPreview(ch); renderBasket(); };
    });
  });
  renderSkillPreview(ch);
}

/* ---------- 스킬 비용 계산/미리보기 ---------- */
function skillCostFor(ch){
  const opt = getSkillOpt(ch);
  const base = costs?.skill_levels || {};
  const ov   = costs?.skill_levels_override?.[ch.name] || {};
  const mst  = costs?.skill_mastery?.[ch.name] || {};
  let acc = {};
  const addObj = o=>{ if(!o) return; for(const [n,c] of Object.entries(o)) acc[n]=(acc[n]||0)+c; };
  const addLv1to7 = ()=>{ for(let lv=2; lv<=7; lv++){ const L=String(lv); addObj(base[L]); addObj(ov[L]); } };
  const addM = (sKey, mKey)=> addObj(mst?.[sKey]?.[mKey]);

  ["s1","s2","s3"].forEach(s=>{
    const o = opt[s]; if(!o) return;
    if(o.lv7) addLv1to7();
    if(o.m1) addM(s,"M1");
    if(o.m2) addM(s,"M2");
    if(o.m3) addM(s,"M3");
  });
  return acc;
}
function renderSkillPreview(ch){
  const box = document.getElementById("skillPreview");
  if(!box) return;
  const sum = skillCostFor(ch);
  const rows = Object.keys(sum).map(name=>{
    const meta = materials[name]||{};
    return { name, label:(meta.label?.ko)||name, icon:meta.icon||"", type:meta.type||"material", count:sum[name] };
  });
  const main = rows.filter(r=>r.type==="material").sort((a,b)=>a.label.localeCompare(b.label,"ko"));
  const misc = rows.filter(r=>r.type==="currency"||r.type==="exp").sort((a,b)=>a.label.localeCompare(b.label,"ko"));

  const mk = (title, arr)=> arr.length? `
    <h4 style="margin:10px 0 4px;color:#aab2c0;font-size:12px">${title}</h4>
    <table><thead><tr><th>아이콘</th><th>재료</th><th>수량</th></tr></thead>
    <tbody>
      ${arr.map(m=>`<tr>
        <td>${imgTag(m.icon, m.name)}</td>
        <td>${m.label}</td>
        <td>${m.count}</td>
      </tr>`).join("")}
    </tbody></table>` : "";
  box.innerHTML = mk("스킬 재료 합계", main) + mk("통화 / EXP 합계", misc);
}

/* ---------- 재귀 확장(캐시) ---------- */
function expandMaterial(name, count){
  if(!expand) return {[name]: count};
  const meta = materials[name], craft = meta?.craft || [];
  if(craft.length===0) return {[name]: count};
  if(!expandCache.has(name)){
    let unit={}; craft.forEach(c=> sumInto(unit, expandMaterial(c.name, c.count)));
    expandCache.set(name, unit);
  }
  const base = expandCache.get(name);
  let acc={}; Object.entries(base).forEach(([k,v])=> acc[k]=(acc[k]||0)+v*count);
  return acc;
}

/* ---------- 정예화 비용 주입(promotion_costs + promotion_fee) ---------- */
function injectCosts(ch, stageKey, acc){
  const add = (obj)=>{ if(!obj) return; for(const [k,v] of Object.entries(obj)) acc[k]=(acc[k]||0)+v; };
  const r = String(ch.rarity ?? "");
  const k = stageKey;
  const kKo = (typeof STAGE_LABELS!=="undefined" && STAGE_LABELS[k]) ? STAGE_LABELS[k] : k; // E1→"1차 정예화" 대응
  add((costs?.promotion_costs?.[r]?.[k])  || (costs?.promotion_costs?.[r]?.[kKo]));
  add((costs?.promotion_fee?.[r]?.[k])    || (costs?.promotion_fee?.[r]?.[kKo]));
}

/* ---------- 장바구니 ---------- */
function renderBasket(){
  $("#selCount").textContent = `${selected.length}명 선택됨`;

  // 선택 목록
  const listWrap = $("#selList"); listWrap.innerHTML = "";
  selected.forEach(i=>{
    const ch = data[i];
    const node = document.createElement("div");
    node.className = "selItem";
    node.innerHTML = `<span>${dispChar(ch)}</span><button onclick="toggleSelect(${i})">제거</button>`;
    listWrap.appendChild(node);
  });

  // 합산
  let sum = {};
  selected.forEach(i=>{
    const ch = data[i];
    for(const [stageKey, mats] of Object.entries(ch.stages||{})){
      (mats||[]).forEach(m=>{ sumInto(sum, expandMaterial(m.name, m.count)); });
      injectCosts(ch, stageKey, sum);
    }
    // 스킬 체크 옵션 합산
    const sk = skillCostFor(ch);
    sumInto(sum, sk);
  });

  const rows = Object.keys(sum).map(name=>{
    const meta = materials[name] || {};
    return {
      name,
      label: (meta.label?.ko) || name,
      count: sum[name],
      rarity: meta.rarity ?? 0,
      icon: meta.icon || "",
      type: meta.type || "material",
      tier: meta.tier || "low"
    };
  });

  const cmp = (a,b)=>{
    if(groupBy==="tier"){
      const t = tierRank(a.tier) - tierRank(b.tier); if(t!==0) return t;
      const r = b.rarity - a.rarity; if(r!==0) return r;
      return a.label.localeCompare(b.label,"ko");
    }else{
      const r = b.rarity - a.rarity; if(r!==0) return r;
      return a.label.localeCompare(b.label,"ko");
    }
  };

  const main = rows.filter(x=>x.type==="material").sort(cmp);
  const misc = rows.filter(x=>x.type==="currency" || x.type==="exp").sort((a,b)=>a.label.localeCompare(b.label,"ko"));

  const bodyMain = document.querySelector("#basketTable tbody");
  const bodyMisc = document.querySelector("#basketMisc tbody");
  bodyMain.innerHTML = ""; bodyMisc.innerHTML = "";

  const renderRows = (arr, tbody)=>{
    let prevTier = null;
    arr.forEach(m=>{
      if(groupBy==="tier"){
        const t = String(m.tier||"low").toLowerCase();
        if(t!==prevTier){
          const gh = document.createElement("tr");
          gh.className = "group";
          gh.innerHTML = `<td colspan="4">${TIER_LABEL[t]||"하위"}</td>`;
          tbody.appendChild(gh); prevTier = t;
        }
      }
      const have = owned[m.name] || 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${imgTag(m.icon, m.name)}</td>
        <td>${m.label}</td>
        <td>${m.count}</td>
        <td><input type="number" value="${have}" min="0"
          style="width:90px;background:var(--panel);border:1px solid var(--bd);color:#e6e9ef;padding:6px;border-radius:6px"
          onchange="updateOwned('${m.name}', this.value)" /></td>`;
      tbody.appendChild(tr);
    });
  };

  renderRows(main, bodyMain);
  renderRows(misc, bodyMisc);
}

function updateOwned(name, val){
  owned[name] = Math.max(0, parseInt(val||"0",10)||0);
  localStorage.setItem("owned_v1", JSON.stringify(owned));
}
</script>
</body>
</html>


