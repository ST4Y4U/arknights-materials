<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>명일방주 재료 계산기</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 보안 최소 설정 -->
  <meta http-equiv="Content-Security-Policy"
  content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'">
  <meta name="referrer" content="no-referrer">
  <style>
    :root{ --bg:#0f1115; --panel:#171a21; --muted:#aab2c0; --pri:#20c997; --bd:#2a2f3a; --card:#1b1f27; --sel:#243548; --red:#d9534f;}
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif; background:var(--bg); color:#e6e9ef; display:flex; flex-direction:column; min-height:100vh}
    header{padding:12px 16px; background:#10131a; border-bottom:1px solid var(--bd); display:flex; flex-direction:column; gap:8px}
    .topbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    header h1{margin:0; font-size:18px; font-weight:600}
    .sp{flex:1}
    .ctrl{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input[type="search"]{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:8px 10px; border-radius:8px; width:240px}
    select,button,label.switch{background:var(--panel); border:1px solid var(--bd); color:#e6e9ef; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer}
    #tagBar{display:flex; gap:8px; flex-wrap:wrap; padding:0 12px 8px}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--bd); background:var(--panel); cursor:pointer; color:#cfd6e3}
    .chip.active{outline:2px solid var(--pri)}
    main{display:grid; grid-template-columns: 1fr 1fr; gap:0; flex:1; min-height:0}
    #left{border-right:1px solid var(--bd); min-height:0; display:flex; flex-direction:column}
    #gallery{padding:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:12px; overflow:auto}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:12px; padding:8px; cursor:pointer; transition:transform .05s ease; display:flex; flex-direction:column; gap:6px}
    .card:hover{transform:translateY(-1px)}
    .card.selected{outline:2px solid var(--pri); background:var(--sel)}
    .card img{width:100%; aspect-ratio: 6 / 5; object-fit: cover; padding:8px; border-radius:8px; background:#0b0d12; display:block;}
@supports not (aspect-ratio: 1 / 1){
  .card img{ width:100%; height:150px; } }
    .name{font-size:13px; font-weight:600}
    .tags{display:flex; flex-wrap:wrap; gap:6px}
    .tag{font-size:11px; padding:2px 6px; border-radius:999px; background:#0f1420; border:1px solid var(--bd); color:#aab2c0}
    .pager{display:flex; gap:8px; align-items:center; justify-content:center; padding:8px 12px; border-top:1px solid var(--bd)}
    .pager button{min-width:64px}
    #right{min-height:0; display:flex; flex-direction:column}
    #details{padding:12px; overflow:auto; position:relative}
    #details h2{margin:4px 0 8px; font-size:18px}
    .detailWrap{ position:relative; }
    .detailContent{ position:relative; z-index:1; display:flex; flex-direction:column; gap:12px;}
    .bgE2{ position:absolute; inset:0; background:center/contain no-repeat; opacity:0; transition:opacity .35s ease; filter:grayscale(100%); pointer-events:none; }
    .bgE2.show{ opacity:.14; }
    .tbl{width:100%; border-collapse:collapse; font-size:13px; margin:0; background:var(--card); border:1px solid var(--bd); border-radius:8px; overflow:hidden; background: rgba(27,31,39,0.60); backdrop-filter: blur(3px)}
    .tbl th,.tbl td{border-bottom:1px solid var(--bd); padding:6px; text-align:center}
    .tbl th{background:#121722; color:#cdd6e5}
    .tbl td:first-child,.tbl th:first-child{text-align:left}
    .optCol label{display:block; margin:4px 0}
    .small{font-size:12px; color:#aab2c0}
    .rightTools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:start}
    #basketWrap{background:#0f131a; border-top:1px solid var(--bd)}
    .scrollArea{ max-height:360px; overflow:auto; border:1px solid var(--bd); border-radius:8px; }
    .scrollArea table{ width:100%; border-collapse:collapse; font-size:13px }
    .scrollArea th,.scrollArea td{border:1px solid var(--bd); padding:6px; text-align:center}
    .scrollArea th{background:#121722; color:#cdd6e5; position:sticky; top:0; z-index:1}
td img{width:22px; height:22px; object-fit:contain; border-radius:4px; background: transparent}
    .selList{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; max-height:120px; overflow:auto; padding:4px}
    .selItem{display:inline-flex; gap:6px; align-items:center; background:var(--panel); border:1px solid var(--bd); padding:4px 6px; border-radius:999px}
    .selItem button{padding:0; width:20px; height:20px; line-height:18px; font-size:14px; border-radius:10px}
    footer{padding:10px 12px; color:#aab2c0; border-top:1px solid var(--bd); background:#0f1115}
    .miscGrid{display:grid; grid-template-rows: 1fr 2fr; gap:8px}
    .currencyArea .scrollArea{max-height:120px}
    .otherArea .scrollArea{max-height:220px}
    .btnPri{background:#112821; border-color:#1d6; color:#bff3e3}
    .btnPri:hover{filter:brightness(1.05)}
    .btnDanger{background:#2a1717; border-color:#a33; color:#f4c9c9}
    .btnDanger:hover{filter:brightness(1.05)}
    .pill{font-size:12px; color:#9fb; background:#0f1d18; border:1px solid #1d3; padding:2px 8px; border-radius:999px}
#selMeta{display:none;}
    @media (max-width: 1024px){
      main{grid-template-columns:1fr}
      #left{border-right:none; border-bottom:1px solid var(--bd)}
      .grid2{grid-template-columns:1fr}
      .miscGrid{grid-template-rows:auto auto}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <h1>명일방주 재료 계산기</h1>
      <div class="sp"></div>
      <div class="ctrl">
        <input id="q" type="search" placeholder="캐릭터 이름으로 검색" />
        <label>하위 재료 포함
          <select id="expandTo">
            <option value="-1">미포함</option>
            <option value="1">희귀도 ≤ 1</option>
            <option value="2">희귀도 ≤ 2</option>
            <option value="3">희귀도 ≤ 3</option>
            <option value="4">희귀도 ≤ 4</option>
          </select>
        </label>
        <label>합계 정렬
          <select id="sumSort">
            <option value="count">필요 재료 최다순</option>
            <option value="rarity">희귀도순</option>
            <option value="name">이름순</option>
          </select>
        </label>
        <label>갤러리 정렬
          <select id="gallerySort">
            <option value="release">출시순</option>
            <option value="rarity">희귀도순</option>
            <option value="name">이름순</option>
          </select>
        </label>
        <button id="sortDirBtn">오름차순</button>
      </div>
    </div>
  </header>

  <main>
    <section id="left">
      <div id="tagBar"></div>
      <div id="gallery"></div>
      <div class="pager">
        <button id="prevPage">이전</button>
        <span class="small" id="pageInfo">1 / 1</span>
        <button id="nextPage">다음</button>
      </div>
    </section>

    <section id="right">
      <div class="rightTools">
        <button id="clearSel" class="btnPri">선택 초기화</button>
        <button id="clearOwn" class="btnDanger">확보 수량 초기화</button>
        <span class="pill" id="selMeta"></span>
      </div>
      <div id="details"><em class="small">좌측에서 캐릭터를 선택하세요.</em></div>
    </section>
  </main>

  <section id="basketWrap">
    <details open>
      <summary>
        <strong>필요 재료 합계</strong>
        <span class="pill" id="selCount">0명 선택됨</span>
      </summary>

      <div class="selList" id="selList"></div>

      <div class="grid2" style="margin-top:8px">
        <!-- 좌: 재료 -->
        <div>
          <div class="scrollArea">
            <table id="basketTable">
              <thead>
                <tr><th>아이콘</th><th>재료</th><th>필요</th><th>확보</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- 우: LMD/EXP + 기타 -->
        <div class="miscGrid">
          <div class="currencyArea">
            <div class="scrollArea">
              <table id="basketCurrency">
                <thead>
                  <tr><th>아이콘</th><th>항목</th><th>필요</th><th>확보</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="otherArea">
            <div class="scrollArea">
              <table id="basketMiscOther">
                <thead>
                  <tr><th>아이콘</th><th>항목</th><th>필요</th><th>확보</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="small" style="margin:6px 0 0">
            확보 수량은 이 브라우저의 LocalStorage에 저장됩니다. 정예화에 필요한 용문폐는 합계에 자동 반영됩니다.
          </div>
        </div>
      </div>
    </details>
  </section>

  <footer>
    <details>
      <summary>도움말 / 출처</summary>
      <div class="small" id="aboutBox">
        • 사용법: 좌측에서 캐릭터를 선택하고 우측 옵션을 설정하세요.<br>
        • 출처: 작성자 제공 자료 및 게임 내 표기. 외부 출처는 추후 추가.
      </div>
    </details>
  </footer>

<script>
/* ---------- 보안용 escape ---------- */
const ESC_MAP={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}
const esc=s=>String(s).replace(/[&<>"']/g,c=>ESC_MAP[c]);

/* ---------- 라벨/상수 ---------- */
const STAGE_LABELS = { E1: "1차 정예화", E2: "2차 정예화" };
const STAGE_REVERSE = Object.fromEntries(Object.entries(STAGE_LABELS).map(([k,v])=>[v,k]));
const stageDisp = s => STAGE_LABELS[s] || s;

/* LMD/EXP 그룹 판별 */
const MISC_NAME_SET = new Set([
  "모듈 데이터 칩","데이터 리더기","데이터 메모리","스킬개론 시리즈",
  "Module Data Block","Data Supplement Stick","Data Supplement Instrument","Data Crystal",
  "Skill Summary - 1","Skill Summary - 2","Skill Summary - 3"
]);
function isMiscRow(r){
  if (r.type==="currency" || r.type==="exp" || r.name==="LMD" || r.name==="EXP") return true;
  if (MISC_NAME_SET.has(r.name)) return true;
  const ko = (materials[r.name]?.label?.ko)||"";
  if (ko.includes("스킬개론")) return true;
  return false;
}

/* ---------- 상태 ---------- */
let data=[], materials={}, costs={};
let selected=[], lastDetail=-1;
let owned = JSON.parse(localStorage.getItem("owned_v1") || "{}");
let activeTags = new Set(); let query = "";
let sortBy = "release"; let sortDir = "asc";
let page=1, pageSize=48, filteredCount=0;
let expandTo = -1;
let sumSort = "count";

/* 스킬 옵션: 1~7 + 마스터리 */
let skillOpt = JSON.parse(localStorage.getItem("skillOpt_v3") || "{}");
function getSkillOpt(ch){
  const k = ch.name;
  if(!skillOpt[k]) skillOpt[k] = {
    lvTarget: 1,
    s1:{m1:false,m2:false,m3:false},
    s2:{m1:false,m2:false,m3:false},
    s3:{m1:false,m2:false,m3:false}
  };
  return skillOpt[k];
}
function saveSkillOpt(){ localStorage.setItem("skillOpt_v3", JSON.stringify(skillOpt)); }

/* 모듈/레벨업 프리셋 + 단계 포함 */
let modOpt = JSON.parse(localStorage.getItem("modOpt_v2") || "{}");
function getModOpt(ch){
  const k = ch.name;
  if(!modOpt[k]) modOpt[k] = { levelPreset: 0, types:{}, stages:{E1:true,E2:true} };
  (ch.modules||[]).forEach(t=>{ if(typeof modOpt[k].types[t]==="undefined") modOpt[k].types[t]=0; });
  if(!modOpt[k].stages) modOpt[k].stages = {E1:true,E2:true};
  if(typeof modOpt[k].levelPreset!=="number") modOpt[k].levelPreset = 0;
  return modOpt[k];
}
function saveModOpt(){ localStorage.setItem("modOpt_v2", JSON.stringify(modOpt)); }

/* ---------- 유틸 ---------- */
const $ = s => document.querySelector(s);
function disp(name){ return (materials[name]?.label?.ko) || name; }
function dispChar(ch){ return (ch.label?.ko) || ch.name; }
function slug(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,""); }

/* 유령 텍스트노드 제거기 */
function scrubGhostArrows(root=document.body){
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
  let n; const re = /^\s*(?:&quot;|&#34;|")?\s*>\s*$/;
  while ((n = walker.nextNode())) if (re.test(n.nodeValue)) n.nodeValue = "";
}

/* 아이콘 태그 생성기: 꼬리 '">', '&quot;>' 절단 강화판 */
function imgTag(src, name){
  const guess = name ? `icons/${slug(name)}.png` : (src||"");
  let s = (src && String(src).trim()) ? src : guess;
  // 끝에 붙은 따옴표/엔티티/공백/꺾쇠 제거
  s = s.replace(/\s*(?:&quot;|&#34;|"|')?\s*>?\s*$/g, "");
  const sAttr = s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const ph = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><rect width="100%25" height="100%25" fill="%2310171f"/></svg>';
  return `<img src="${sAttr}" alt="" width="22" height="22" loading="lazy" decoding="async"
           onerror="this.src='${ph}'">`;
}

function sumInto(target, delta){ if(!delta) return; for(const [k,v] of Object.entries(delta)) target[k]=(target[k]||0)+v; }
async function fetchJSON(url, fb={}){ try{ const r=await fetch(url); if(!r.ok) throw 0; return await r.json(); }catch{ console.warn('LOAD_FAIL',url); return fb; } }

/* ---------- 초기화 ---------- */
(async function init(){
  [data, materials, costs] = await Promise.all([
    fetchJSON("data.json", []),
    fetchJSON("materials.json", {}),
    fetchJSON("costs.json", {})
  ]);
  renderTagBar();
  renderGallery();
  renderBasket();
  bindEvents();
  scrubGhostArrows(); // 초기 1회 청소
})();

/* ---------- 이벤트 ---------- */
function bindEvents(){
  $("#expandTo").addEventListener("change", e=>{ expandTo = parseInt(e.target.value,10); renderBasket(); });
  $("#sumSort").addEventListener("change", e=>{ sumSort = e.target.value; renderBasket(); });
  $("#gallerySort").addEventListener("change", e=>{ sortBy = e.target.value; renderGallery(); });
  $("#sortDirBtn").addEventListener("click", ()=>{
    sortDir = (sortDir === "asc") ? "desc" : "asc";
    $("#sortDirBtn").textContent = (sortDir === "asc") ? "오름차순" : "내림차순";
    renderGallery();
  });
  let qTimer=null;
  $("#q").addEventListener("input", e=>{
    clearTimeout(qTimer);
    qTimer=setTimeout(()=>{ query = e.target.value.trim().toLowerCase(); page=1; renderGallery(); },150);
  });
  $("#prevPage").addEventListener("click", ()=>{ if(page>1){ page--; renderGallery(); } });
  $("#nextPage").addEventListener("click", ()=>{
    const total = Math.max(1, Math.ceil(filteredCount/pageSize));
    if(page<total){ page++; renderGallery(); }
  });
  $("#clearSel").addEventListener("click", ()=>{ selected = []; lastDetail = -1; renderGallery(); renderDetails(); renderBasket(); });
  $("#clearOwn").addEventListener("click", ()=>{ owned = {}; localStorage.setItem("owned_v1", JSON.stringify(owned)); renderBasket(); });
}

/* ---------- 태그 바 ---------- */
function renderTagBar(){
  const bar = $("#tagBar"); bar.innerHTML = "";
  const tagSet = new Set(); data.forEach(ch => (ch.tags||[]).forEach(t=>tagSet.add(t)));
  const tags = Array.from(tagSet).sort((a,b)=>a.localeCompare(b,"ko"));
  if(tags.length===0){ bar.innerHTML = `<span class="small">태그 없음</span>`; return; }
  tags.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "chip"; btn.textContent = t; // textContent는 자체 안전
    btn.onclick = ()=>{ if(activeTags.has(t)) activeTags.delete(t); else activeTags.add(t); btn.classList.toggle("active"); page=1; renderGallery(); };
    bar.appendChild(btn);
  });
}

/* ---------- 갤러리 ---------- */
function matchesFilters(ch){
  const q = query;
  if(q==="") return activeTags.size===0 ? true : (ch.tags||[]).some(t=>activeTags.has(t));
  const nameKo = (ch.label?.ko || "").toLowerCase();
  const nameEn = (ch.label?.en || ch.name || "").toLowerCase();
  const inName = nameKo.includes(q) || nameEn.includes(q);
  const tagsPass = activeTags.size===0 ? true : (ch.tags||[]).some(t=>activeTags.has(t));
  return inName && tagsPass;
}
function renderGallery(){
  const g = $("#gallery"); g.innerHTML = "";
  const items = data.filter(matchesFilters);
  filteredCount = items.length;

  const nameKey = ch => (ch.label?.ko || ch.label?.en || ch.name || "");
  const getRelease = ch => (typeof ch.release === "number" ? ch.release :
                           (ch.releaseDate ? Date.parse(ch.releaseDate)||0 : 0));
  const cmpChar = (a,b)=>{
    let cmp = 0;
    if (sortBy === "release") cmp = getRelease(a) - getRelease(b);
    else if (sortBy === "rarity") cmp = (a.rarity||0) - (b.rarity||0);
    else cmp = nameKey(a).localeCompare(nameKey(b), "ko");
    if (cmp !== 0) return (sortDir === "asc") ? cmp : -cmp;
    return nameKey(a).localeCompare(nameKey(b), "ko");
  };
  items.sort(cmpChar);

  const total = Math.max(1, Math.ceil(filteredCount/pageSize));
  if(page>total) page = total;
  $("#pageInfo").textContent = `${page} / ${total}`;

  const start = (page-1)*pageSize;
  const slice = items.slice(start, start+pageSize);

  const frag = document.createDocumentFragment();
  slice.forEach(ch=>{
    const idx = data.indexOf(ch);
    const card = document.createElement("div");
    card.className = "card" + (selected.includes(idx) ? " selected" : "");
    card.innerHTML = `
      <img src="${ch.image||""}" loading="lazy" decoding="async" onerror="this.style.display='none'">
      <div class="name">${esc(dispChar(ch))}</div>
      <div class="tags">${(ch.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join("")}</div>`;
    card.onclick = ()=>{ toggleSelect(idx); lastDetail=idx; renderDetails(); };
    frag.appendChild(card);
  });
  g.appendChild(frag);

  $("#selMeta").textContent = `${selected.length}명 선택됨`;
  scrubGhostArrows(); // 렌더 후 청소
}
function toggleSelect(i){
  const pos = selected.indexOf(i);
  if(pos===-1) selected.push(i); else selected.splice(pos,1);
  renderGallery(); renderBasket(); renderDetails();
}

/* ---------- 상세 ---------- */
function allowedLvPresetsByRarity(r){
  if(r<=2) return [0,1];
  if(r===3) return [0,1,2];
  return [0,1,2,3,4];
}
function renderDetails(){
  const d = $("#details");
  if(selected.length===0){ d.innerHTML = `<em class="small">좌측에서 캐릭터를 선택하세요.</em>`; return; }
  if(lastDetail===-1 || !selected.includes(lastDetail)) lastDetail = selected[selected.length-1];
  const ch = data[lastDetail];
  const mo = getModOpt(ch);
  const sk = getSkillOpt(ch);

  let html = `<h2>${esc(dispChar(ch))}</h2>`;

  const stageEntries = Object.entries(ch.stages||{});
  const stageTables = stageEntries.map(([stage, mats])=>{
    if(typeof mo.stages?.[stage] === "undefined") mo.stages[stage] = true;
    const checked = mo.stages[stage] ? "checked" : "";
    return `
      <table class="tbl">
        <thead>
          <tr>
            <th style="text-align:left">
              ${esc(stageDisp(stage))}
              <label class="small" style="margin-left:8px"><input type="checkbox" data-stage="${stage}" ${checked}> 포함</label>
            </th>
            <th>아이콘</th><th>재료</th><th>수량</th>
          </tr>
        </thead>
        <tbody>
          ${(mats||[]).map(m=>{
            const meta = materials[m.name]||{};
            return `<tr>
              <td></td>
              <td>${imgTag(meta.icon, m.name)}</td>
              <td>${esc(disp(m.name))}</td>
              <td>${m.count}</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>`;
  }).join("");
  if(stageTables){ html += `<div class="grid2">${stageTables}</div>`; }

  const r = ch.rarity||0;
  const allowed = allowedLvPresetsByRarity(r);
  if(!allowed.includes(mo.levelPreset||0)){ mo.levelPreset = 0; saveModOpt(); }
  const radio = (val,label)=> allowed.includes(val)
    ? `<label><input type="radio" name="lvPreset" value="${val}" ${mo.levelPreset===val?'checked':''}> ${esc(label)}</label>`
    : "";

  const leftCol = `
    <table class="tbl">
      <thead><tr><th style="text-align:left">레벨업 프리셋</th><th>선택</th></tr></thead>
      <tbody>
        <tr>
          <td>프리셋</td>
          <td class="optCol" style="text-align:left">
            ${radio(0,"선택 안 함")}
            ${radio(1,"~0차 + 최대 레벨")}
            ${radio(2,"~1차 + 최대 레벨")}
            ${radio(3,"~2차 + 모듈 최소 레벨")}
            ${radio(4,"~2차 + 최대 레벨")}
          </td>
        </tr>
      </tbody>
    </table>`;

  let rightCol = "";
  if(r>=3){
    const hasMastery = r>3;
    const sLbl = (k, fb)=>{
      const src = ch.skills?.[k]?.icon || "";
      const img = src ? `<img src="${src}" alt="${esc(fb)}" width="22" height="22" style="vertical-align:middle;border-radius:4px;background:#0b0d12;margin-right:6px">` : "";
      return img+esc(fb);
    };
    let rows = `
      <tr>
        <td>스킬 1~7레벨</td>
        <td colspan="3" style="text-align:left">
          목표 레벨
          <select id="lvTarget">
            ${[1,2,3,4,5,6,7].map(n=>`<option value="${n}" ${sk.lvTarget===n?'selected':''}>${n}</option>`).join('')}
          </select>
          <span class="small">(1은 미선택)</span>
        </td>
      </tr>`;
    if(hasMastery){
      rows += `
        <tr><td>${sLbl("s1","스킬 1")}</td>
          <td><label><input type="checkbox" id="s1_m1" ${sk.s1.m1?'checked':''}> 8</label></td>
          <td><label><input type="checkbox" id="s1_m2" ${sk.s1.m2?'checked':''}> 9</label></td>
          <td><label><input type="checkbox" id="s1_m3" ${sk.s1.m3?'checked':''}> 10</label></td></tr>
        <tr><td>${sLbl("s2","스킬 2")}</td>
          <td><label><input type="checkbox" id="s2_m1" ${sk.s2.m1?'checked':''}> 8</label></td>
          <td><label><input type="checkbox" id="s2_m2" ${sk.s2.m2?'checked':''}> 9</label></td>
          <td><label><input type="checkbox" id="s2_m3" ${sk.s2.m3?'checked':''}> 10</label></td></tr>
        <tr><td>${sLbl("s3","스킬 3")}</td>
          <td><label><input type="checkbox" id="s3_m1" ${sk.s3.m1?'checked':''}> 8</label></td>
          <td><label><input type="checkbox" id="s3_m2" ${sk.s3.m2?'checked':''}> 9</label></td>
          <td><label><input type="checkbox" id="s3_m3" ${sk.s3.m3?'checked':''}> 10</label></td></tr>`;
    }
    rightCol = `
      <table class="tbl">
        <thead><tr><th style="text-align:left">스킬 옵션</th><th colspan="3">선택</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  html += `<div class="grid2">${leftCol}${rightCol}</div>`;

  const mods = (ch.modules||[]).filter(t=>{
    const ov   = costs?.module_override?.[ch.name]?.[t];
    const base = costs?.module_costs?.[t];
    return !!(ov || base);
  });
  if(mods.length){
    const moState = getModOpt(ch);
    html += `
      <table class="tbl">
        <thead><tr><th style="text-align:left">모듈</th><th>선택</th></tr></thead>
        <tbody>
          ${mods.map(t=>{
            const lv = moState.types?.[t] ?? 0;
            return `<tr>
              <td>${esc(t)}</td>
              <td>
                <select class="modSelect" data-mod="${t}">
                  <option value="0" ${lv===0?'selected':''}>선택 안 함</option>
                  <option value="1" ${lv===1?'selected':''}>1레벨</option>
                  <option value="2" ${lv===2?'selected':''}>2레벨</option>
                  <option value="3" ${lv===3?'selected':''}>3레벨</option>
                </select>
              </td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>`;
  }

  d.innerHTML = `<div class="detailWrap"><div class="bgE2" id="bgE2"></div><div class="detailContent">${html}</div></div>`;
  const bg = d.querySelector("#bgE2"); if(ch.imageE2){ bg.style.backgroundImage = `url('${ch.imageE2}')`; requestAnimationFrame(()=> bg.classList.add("show")); }

  d.querySelectorAll('input[data-stage]').forEach(el=>{
    el.onchange = ()=>{ mo.stages[el.dataset.stage] = el.checked; saveModOpt(); renderBasket(); };
  });
  d.querySelectorAll('input[name="lvPreset"]').forEach(el=>{
    el.onchange = ()=>{ mo.levelPreset = parseInt(el.value,10)||0; saveModOpt(); renderBasket(); };
  });
  const lvSel = d.querySelector('#lvTarget');
  if(lvSel){ lvSel.onchange = ()=>{ sk.lvTarget = parseInt(lvSel.value,10)||1; saveSkillOpt(); renderBasket(); }; }
  ["s1","s2","s3"].forEach(k=>{
    ["m1","m2","m3"].forEach(t=>{
      const el = d.querySelector(`#${k}_${t}`);
      if(el) el.onchange = ()=>{ const o=getSkillOpt(ch)[k]; o[t] = el.checked; saveSkillOpt(); renderBasket(); };
    });
  });
  d.querySelectorAll('.modSelect').forEach(el=>{
    el.onchange = ()=>{ mo.types[el.dataset.mod] = parseInt(el.value,10)||0; saveModOpt(); renderBasket(); };
  });

  scrubGhostArrows(); // 렌더 후 청소
}

/* ---------- 스킬 비용 ---------- */
function skillLv1to7CostFor(ch){
  const opt = getSkillOpt(ch);
  const target = Math.max(1, Math.min(7, opt.lvTarget||1));
  if(target<=1) return {};
  const base = costs?.skill_levels || {};
  const baseR = base?.[String(ch.rarity||"")] || {};
  const ov   = costs?.skill_levels_override?.[ch.name] || {};
  let acc = {};
  const addObj = o=>{ if(!o) return; for(const [n,c] of Object.entries(o)) acc[n]=(acc[n]||0)+c; };
  for(let lv=2; lv<=target; lv++){
    const L=String(lv);
    addObj(baseR[L]); addObj(ov[L]);
  }
  return acc;
}
function skillMasteryCostFor(ch){
  if((ch.rarity||0)<=3) return {};
  const opt = getSkillOpt(ch);
  const mst  = costs?.skill_mastery?.[ch.name] || {};
  let acc = {};
  const addObj = o=>{ if(!o) return; for(const [n,c] of Object.entries(o)) acc[n]=(acc[n]||0)+c; };
  const addM = (sKey, mKey)=> addObj(mst?.[sKey]?.[mKey]);
  ["s1","s2","s3"].forEach(s=>{
    const o = opt[s]; if(!o) return;
    if(o.m1) addM(s,"M1");
    if(o.m2) addM(s,"M2");
    if(o.m3) addM(s,"M3");
  });
  return acc;
}

/* ---------- 하위 재료 확장 ---------- */
function expandMaterial(name, count, thr){
  if(thr<0) return {[name]: count};
  const meta = materials[name]; const r = meta?.rarity ?? 999;
  const craft = meta?.craft || [];
  if(r <= thr || craft.length===0) return {[name]: count};
  let acc={};
  craft.forEach(c=> sumInto(acc, expandMaterial(c.name, c.count*count, thr)));
  return acc;
}

/* ---------- 정예화/레벨업/모듈 ---------- */
function injectCosts(ch, stageKey, acc){
  const add = (obj)=>{ if(!obj) return; for(const [k,v] of Object.entries(obj)) acc[k]=(acc[k]||0)+v; };
  const r = String(ch.rarity ?? "");
  const k = stageKey;
  const kKo = STAGE_LABELS[k] || k;
  const kEn = STAGE_REVERSE[k] || k;

  add((costs?.promotion_costs?.[r]?.[k])   || (costs?.promotion_costs?.[r]?.[kKo]) || (costs?.promotion_costs?.[r]?.[kEn]));
  add((costs?.promotion_fee?.[r]?.[k])     || (costs?.promotion_fee?.[r]?.[kKo])   || (costs?.promotion_fee?.[r]?.[kEn]));
  add((costs?.promotion_override?.[ch.name]?.[k]) || (costs?.promotion_override?.[ch.name]?.[kKo]) || (costs?.promotion_override?.[ch.name]?.[kEn]));
}
function levelingPresetCost(ch){
  const mo = getModOpt(ch);
  const r = String(ch.rarity ?? "");
  const L = costs?.leveling?.[r] || {};
  const add = k => (L[k]||null);
  let acc = {};
  const addObj = o=>{ if(!o) return; for(const [n,c] of Object.entries(o)) acc[n]=(acc[n]||0)+c; };

  switch(mo.levelPreset){
    case 1: addObj(add("E0max")); break;
    case 2: ["E0max","E1max"].forEach(k=>addObj(add(k))); break;
    case 3: ["E0max","E1max","E2_60"].forEach(k=>addObj(add(k))); break;
    case 4: ["E0max","E1max","E2max"].forEach(k=>addObj(add(k))); break;
    default: ;
  }
  return acc;
}
function moduleCostFor(ch){
  const mo = getModOpt(ch);
  if(!mo.types) return {};
  let acc = {};
  for(const [t,lv] of Object.entries(mo.types)){
    const def = costs?.module_costs?.[t] || {};
    const ov  = costs?.module_override?.[ch.name]?.[t] || {};
    const pick = {...def, ...ov};
    const steps = [1,2,3].filter(n=> lv>=n).map(n=> pick["S"+n]).filter(Boolean);
    steps.forEach(step=>{ for(const [k,v] of Object.entries(step)) acc[k]=(acc[k]||0)+v; });
  }
  return acc;
}

/* ---------- 장바구니(필요 재료 합계) ---------- */
function renderBasket(){
  $("#selCount").textContent = `${selected.length}명 선택됨`;

  const listWrap = $("#selList"); listWrap.innerHTML = "";
  selected.forEach(i=>{
    const ch = data[i];
    const node = document.createElement("div");
    node.className = "selItem";
    node.innerHTML = `<button title="제거" onclick="toggleSelect(${i})">×</button><span>${esc(dispChar(ch))}</span>`;
    listWrap.appendChild(node);
  });

  let sum = {};
  selected.forEach(i=>{
    const ch = data[i];
    const mo = getModOpt(ch);
    for(const [stageKey, mats] of Object.entries(ch.stages||{})){
      if(mo.stages?.[stageKey]===false) continue;
      (mats||[]).forEach(m=>{ sumInto(sum, expandMaterial(m.name, m.count, expandTo)); });
      injectCosts(ch, stageKey, sum);
    }
    sumInto(sum, skillLv1to7CostFor(ch));
    sumInto(sum, skillMasteryCostFor(ch));
    sumInto(sum, levelingPresetCost(ch));
    sumInto(sum, moduleCostFor(ch));
  });

  let rows = Object.keys(sum).map(name=>{
    const meta = materials[name] || {};
    return { name, label:(meta.label?.ko)||name, count:sum[name], rarity:meta.rarity??0, icon:meta.icon||"", type:meta.type||"material" };
  });

  const currencyOrder = ["LMD","EXP"];
  const currency = rows.filter(r => r.name==="LMD" || r.name==="EXP")
                       .sort((a,b)=> currencyOrder.indexOf(a.name)-currencyOrder.indexOf(b.name));
  const miscOther = rows.filter(r => isMiscRow(r) && !(r.name==="LMD"||r.name==="EXP"))
                        .sort((a,b)=> a.label.localeCompare(b.label,"ko"));
  const cmp = {
    count: (a,b)=> (b.count - a.count) || (b.rarity - a.rarity) || a.label.localeCompare(b.label,"ko"),
    rarity:(a,b)=> (b.rarity - a.rarity) || a.label.localeCompare(b.label,"ko"),
    name:  (a,b)=> a.label.localeCompare(b.label,"ko")
  }[sumSort] || ((a,b)=>0);
  const main = rows.filter(x=>!isMiscRow(x)).sort(cmp);

  const bodyMain = document.querySelector("#basketTable tbody");
  const bodyCur  = document.querySelector("#basketCurrency tbody");
  const bodyMO   = document.querySelector("#basketMiscOther tbody");
  bodyMain.innerHTML = ""; bodyCur.innerHTML = ""; bodyMO.innerHTML = "";

  const renderRows = (arr, tbody)=>{
    arr.forEach(m=>{
      const have = owned[m.name] || 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${imgTag(m.icon, m.name)}</td>
        <td>${esc(m.label)}</td>
        <td>${m.count}</td>
        <td><input type="number" value="${have}" min="0"
          style="width:90px;background:var(--panel);border:1px solid var(--bd);color:#e6e9ef;padding:6px;border-radius:6px"
          onchange="updateOwned('${m.name.replace(/'/g,"\\'")}', this.value)" /></td>`;
      tbody.appendChild(tr);
    });
  };
  renderRows(main, bodyMain);
  renderRows(currency, bodyCur);
  renderRows(miscOther, bodyMO);

  $("#selMeta").textContent = `${selected.length}명 선택됨`;
  scrubGhostArrows(); // 렌더 후 청소
}

function updateOwned(name, val){
  owned[name] = Math.max(0, parseInt(val||"0",10)||0);
  localStorage.setItem("owned_v1", JSON.stringify(owned));
}
</script>
</body>
</html>
