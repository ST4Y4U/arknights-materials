<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>명일방주 재료 계산기</title>
  <style>
    body { display:flex; flex-direction:column; font-family:sans-serif; margin:0; }
    header { background:#111; color:#fff; padding:10px; text-align:center; }
    main { display:flex; flex:1; }
    #gallery { flex:1; padding:10px; display:grid; grid-template-columns:repeat(auto-fill,150px); gap:10px; }
    .card { border:1px solid #ccc; border-radius:8px; padding:5px; text-align:center; cursor:pointer; }
    .card img { width:100%; border-radius:4px; }
    #details { flex:1; padding:10px; border-left:1px solid #ccc; }
    #basket { border-top:1px solid #ccc; padding:10px; background:#f5f5f5; }
    table { border-collapse:collapse; width:100%; }
    th, td { border:1px solid #ccc; padding:4px; text-align:center; }
  </style>
</head>
<body>
<header>
  <h1>명일방주 캐릭터 재료 계산기</h1>
  <label><input type="checkbox" id="expandToggle"> 하위 재료 포함</label>
</header>
<main>
  <div id="gallery"></div>
  <div id="details"><em>캐릭터를 선택하세요</em></div>
</main>
<div id="basket">
  <h2>장바구니 합계</h2>
  <table id="basketTable">
    <thead><tr><th>아이콘</th><th>재료</th><th>필요</th><th>확보</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
let data = [];
let materials = {};
let owned = JSON.parse(localStorage.getItem("owned")||"{}");
let selected = [];
let expand = false;

// JSON 불러오기
Promise.all([
  fetch("data.json").then(r=>r.json()),
  fetch("materials.json").then(r=>r.json())
]).then(([d,m])=>{
  data=d;
  materials=m;
  renderGallery();
  renderBasket();
});

// 토글 버튼 이벤트
document.getElementById("expandToggle").addEventListener("change", e=>{
  expand = e.target.checked;
  renderBasket();
});

// 카드 갤러리
function renderGallery(){
  const g=document.getElementById("gallery");
  g.innerHTML="";
  data.forEach((ch,i)=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<img src="${ch.image}"><br>${ch.name}`;
    c.onclick=()=>toggleSelect(i);
    g.appendChild(c);
  });
}

// 캐릭터 선택/해제
function toggleSelect(i){
  const idx=selected.indexOf(i);
  if(idx==-1) selected.push(i); else selected.splice(idx,1);
  renderDetails(i);
  renderBasket();
}

// 캐릭터 상세
function renderDetails(i){
  const d=document.getElementById("details");
  if(selected.indexOf(i)==-1){ d.innerHTML="<em>캐릭터를 선택하세요</em>"; return; }
  const ch=data[i];
  let html=`<h2>${ch.name}</h2>`;
  for(const [stage,mats] of Object.entries(ch.stages)){
    html+=`<h3>${stage}</h3><ul>`;
    mats.forEach(m=>{
      html+=`<li>${m.name} x${m.count}</li>`;
    });
    html+="</ul>";
  }
  html+=`<button onclick="toggleSelect(${i})">선택 해제</button>`;
  d.innerHTML=html;
}

// 합계 계산 (재귀 포함)
function expandMaterial(mat,count){
  if(!expand) return {[mat]:count};
  if(!materials[mat] || materials[mat].craft.length===0) return {[mat]:count};
  let sum={};
  materials[mat].craft.forEach(c=>{
    const sub=expandMaterial(c.name, c.count*count);
    for(const [k,v] of Object.entries(sub)){
      sum[k]=(sum[k]||0)+v;
    }
  });
  return sum;
}

function renderBasket(){
  const tbl=document.querySelector("#basketTable tbody");
  tbl.innerHTML="";
  let sum={};
  selected.forEach(i=>{
    const ch=data[i];
    for(const mats of Object.values(ch.stages)){
      mats.forEach(m=>{
        const expanded=expandMaterial(m.name,m.count);
        for(const [k,v] of Object.entries(expanded)){
          if(!sum[k]) sum[k]=0;
          sum[k]+=v;
        }
      });
    }
  });

  // rarity 기준 정렬
  const list=Object.keys(sum).map(name=>({
    name,
    count:sum[name],
    rarity:(materials[name]&&materials[name].rarity)||0,
    icon:(materials[name]&&materials[name].icon)||""
  })).sort((a,b)=>b.rarity-a.rarity);

  list.forEach(m=>{
    const row=document.createElement("tr");
    const have=owned[m.name]||0;
    row.innerHTML=`<td><img src="${m.icon}" width="24"></td>
                   <td>${m.name}</td>
                   <td>${m.count}</td>
                   <td><input type="number" value="${have}" min="0" onchange="updateOwned('${m.name}',this.value)"></td>`;
    tbl.appendChild(row);
  });
}

function updateOwned(name,val){
  owned[name]=parseInt(val)||0;
  localStorage.setItem("owned",JSON.stringify(owned));
}
</script>
</body>
</html>
